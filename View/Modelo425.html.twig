{% extends "Master/MenuBgTemplate.html.twig" %}

{% block bodyHeaderOptions %}
    {{ parent() }}
    <div class="container-fluid mb-3">
        <div class="row">
            <div class="col-sm-6">
                <h1 class="h3">
                    <i class="fa-solid fa-file-invoice-dollar fa-fw"></i>
                    {{ i18n.trans('modelo-425') }}
                    {% if fsc.selectedEjercicio %}
                        <small class="text-muted">{{ fsc.selectedEjercicio.nombre }}</small>
                    {% endif %}
                </h1>
                <p class="text-muted mb-0">{{ i18n.trans('modelo-425-descripcion') }}</p>
            </div>
            <div class="col-sm-6 text-end">
                {% if fsc.selectedEjercicio and fsc.modeloFiscal is null %}
                    <form action="{{ fsc.url() }}" method="post" class="d-inline">
                        <input type="hidden" name="proceso" value="guardar">
                        <input type="hidden" name="codejercicio" value="{{ fsc.selectedEjercicio.codejercicio }}">
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-save fa-fw"></i> {{ i18n.trans('guardar-modelo-425') }}
                        </button>
                    </form>
                {% endif %}
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fa-solid fa-print fa-fw"></i> {{ i18n.trans('imprimir') }}
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    {{ parent() }}
    <div class="container-fluid">
        {# Selector de ejercicio #}
        <form name="formEjercicio" action="{{ fsc.url() }}" method="post" class="mb-4 d-print-none">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fa-solid fa-calendar fa-fw"></i>
                            {{ i18n.trans('ejercicio') }}
                        </span>
                        <select name="codejercicio" class="form-select" onchange="this.form.submit()">
                            {% for eje in fsc.allEjercicios() %}
                                <option value="{{ eje.codejercicio }}"
                                    {% if fsc.selectedEjercicio and fsc.selectedEjercicio.codejercicio == eje.codejercicio %}selected{% endif %}>
                                    {{ eje.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </form>

        {% if fsc.selectedEjercicio %}
            <div class="row">
                <div class="col-lg-12">
                    {# IGIC Devengado (ventas) #}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="fa-solid fa-arrow-up fa-fw"></i> {{ i18n.trans('igic-devengado') }}
                            <small class="ms-2">({{ i18n.trans('operaciones-ventas') }})</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-end">{{ i18n.trans('base-imponible') }}</th>
                                            <th class="text-end">{{ i18n.trans('tipo-igic') }}</th>
                                            <th class="text-end">{{ i18n.trans('recargo') }}</th>
                                            <th class="text-end">{{ i18n.trans('cuota-igic') }}</th>
                                            <th class="text-end">{{ i18n.trans('cuota-recargo') }}</th>
                                            <th class="text-end">{{ i18n.trans('total') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set totalBaseVentas = 0 %}
                                        {% set totalIGICVentas = 0 %}
                                        {% set totalRecargoVentas = 0 %}
                                        {% for item in fsc.desgloseIGICVentas() %}
                                            {% set totalBaseVentas = totalBaseVentas + item.neto %}
                                            {% set totalIGICVentas = totalIGICVentas + item.totaliva %}
                                            {% set totalRecargoVentas = totalRecargoVentas + item.totalrecargo %}
                                            <tr>
                                                <td class="text-end">{{ money(item.neto) }}</td>
                                                <td class="text-end">{{ item.iva }} %</td>
                                                <td class="text-end">{{ item.recargo }} %</td>
                                                <td class="text-end">{{ money(item.totaliva) }}</td>
                                                <td class="text-end">{{ money(item.totalrecargo) }}</td>
                                                <td class="text-end">{{ money(item.totaliva + item.totalrecargo) }}</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="6" class="text-muted text-center">{{ i18n.trans('sin-datos') }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-primary">
                                        <tr>
                                            <th class="text-end">{{ money(totalBaseVentas) }}</th>
                                            <th></th>
                                            <th></th>
                                            <th class="text-end">{{ money(totalIGICVentas) }}</th>
                                            <th class="text-end">{{ money(totalRecargoVentas) }}</th>
                                            <th class="text-end"><strong>{{ money(fsc.totalDevengado()) }}</strong></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    {# IGIC Deducible (compras) #}
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <i class="fa-solid fa-arrow-down fa-fw"></i> {{ i18n.trans('igic-deducible') }}
                            <small class="ms-2">({{ i18n.trans('operaciones-compras') }})</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-end">{{ i18n.trans('base-imponible') }}</th>
                                            <th class="text-end">{{ i18n.trans('tipo-igic') }}</th>
                                            <th class="text-end">{{ i18n.trans('recargo') }}</th>
                                            <th class="text-end">{{ i18n.trans('cuota-igic') }}</th>
                                            <th class="text-end">{{ i18n.trans('cuota-recargo') }}</th>
                                            <th class="text-end">{{ i18n.trans('total') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set totalBaseCompras = 0 %}
                                        {% set totalIGICCompras = 0 %}
                                        {% set totalRecargoCompras = 0 %}
                                        {% for item in fsc.desgloseIGICCompras() %}
                                            {% set totalBaseCompras = totalBaseCompras + item.neto %}
                                            {% set totalIGICCompras = totalIGICCompras + item.totaliva %}
                                            {% set totalRecargoCompras = totalRecargoCompras + item.totalrecargo %}
                                            <tr>
                                                <td class="text-end">{{ money(item.neto) }}</td>
                                                <td class="text-end">{{ item.iva }} %</td>
                                                <td class="text-end">{{ item.recargo }} %</td>
                                                <td class="text-end">{{ money(item.totaliva) }}</td>
                                                <td class="text-end">{{ money(item.totalrecargo) }}</td>
                                                <td class="text-end">{{ money(item.totaliva + item.totalrecargo) }}</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="6" class="text-muted text-center">{{ i18n.trans('sin-datos') }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-success">
                                        <tr>
                                            <th class="text-end">{{ money(totalBaseCompras) }}</th>
                                            <th></th>
                                            <th></th>
                                            <th class="text-end">{{ money(totalIGICCompras) }}</th>
                                            <th class="text-end">{{ money(totalRecargoCompras) }}</th>
                                            <th class="text-end"><strong>{{ money(fsc.totalDeducible()) }}</strong></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    {# Resultado anual #}
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fa-solid fa-equals fa-fw"></i> {{ i18n.trans('resultado-anual') }}
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h5 class="text-muted">{{ i18n.trans('total-devengado') }}</h5>
                                    <h3 class="text-primary">{{ money(fsc.totalDevengado()) }}</h3>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="text-muted">{{ i18n.trans('total-deducible') }}</h5>
                                    <h3 class="text-success">{{ money(fsc.totalDeducible()) }}</h3>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="text-muted">{{ i18n.trans('resultado') }}</h5>
                                    {% set resultado = fsc.resultado() %}
                                    <h3 class="{% if resultado >= 0 %}text-danger{% else %}text-success{% endif %}">
                                        {{ money(resultado) }}
                                    </h3>
                                    <p class="text-muted mb-0">
                                        {% if resultado > 0 %}
                                            {{ i18n.trans('resultado-a-ingresar') }}
                                        {% elseif resultado < 0 %}
                                            {{ i18n.trans('resultado-a-favor') }}
                                        {% else %}
                                            {{ i18n.trans('resultado-cero') }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Estado del modelo fiscal #}
                    {% if fsc.modeloFiscal %}
                        <div class="card mb-4 d-print-none">
                            <div class="card-header">
                                <i class="fa-solid fa-file-circle-check fa-fw"></i> {{ i18n.trans('estado-modelo') }}
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong>{{ i18n.trans('estado') }}:</strong>
                                            <span class="badge bg-{{ fsc.modeloFiscal.estadoClase() }}">
                                                {{ fsc.modeloFiscal.estadoDescripcion() }}
                                            </span>
                                        </p>
                                        {% if fsc.modeloFiscal.numeroreferencia %}
                                            <p class="mb-2">
                                                <strong>{{ i18n.trans('numero-referencia-atc') }}:</strong>
                                                {{ fsc.modeloFiscal.numeroreferencia }}
                                            </p>
                                        {% endif %}
                                        {% if fsc.modeloFiscal.fechapresentacion %}
                                            <p class="mb-0">
                                                <strong>{{ i18n.trans('fecha-presentacion') }}:</strong>
                                                {{ fsc.modeloFiscal.fechapresentacion }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 text-end">
                                        {% if fsc.modeloFiscal.estado == 'borrador' %}
                                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalMarcarPresentado425">
                                                <i class="fa-solid fa-check fa-fw"></i> {{ i18n.trans('marcar-presentado') }}
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {# Modelos 420 trimestrales #}
                    {% set modelos420 = fsc.getModelos420() %}
                    {% if modelos420|length > 0 %}
                        <div class="card mb-4 d-print-none">
                            <div class="card-header">
                                <i class="fa-solid fa-list fa-fw"></i> {{ i18n.trans('modelos-420-trimestrales') }}
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>{{ i18n.trans('periodo') }}</th>
                                                <th class="text-end">{{ i18n.trans('total-devengado') }}</th>
                                                <th class="text-end">{{ i18n.trans('total-deducible') }}</th>
                                                <th class="text-end">{{ i18n.trans('resultado') }}</th>
                                                <th class="text-center">{{ i18n.trans('estado') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set sumDevengado = 0 %}
                                            {% set sumDeducible = 0 %}
                                            {% for modelo in modelos420 %}
                                                {% set sumDevengado = sumDevengado + modelo.totaldevengado %}
                                                {% set sumDeducible = sumDeducible + modelo.totaldeducible %}
                                                <tr>
                                                    <td>{{ modelo.periodo }}</td>
                                                    <td class="text-end">{{ money(modelo.totaldevengado) }}</td>
                                                    <td class="text-end">{{ money(modelo.totaldeducible) }}</td>
                                                    <td class="text-end">{{ money(modelo.resultado) }}</td>
                                                    <td class="text-center">
                                                        <span class="badge bg-{{ modelo.estadoClase() }}">{{ modelo.estadoDescripcion() }}</span>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <th>{{ i18n.trans('total') }}</th>
                                                <th class="text-end">{{ money(sumDevengado) }}</th>
                                                <th class="text-end">{{ money(sumDeducible) }}</th>
                                                <th class="text-end">{{ money(sumDevengado - sumDeducible) }}</th>
                                                <th></th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {# Información adicional #}
                    <div class="card mb-4 d-print-none">
                        <div class="card-header">
                            <i class="fa-solid fa-info-circle fa-fw"></i> {{ i18n.trans('informacion-modelo-425') }}
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>{{ i18n.trans('ejercicio') }}:</strong>
                                {{ fsc.selectedEjercicio.nombre }}
                                ({{ fsc.selectedEjercicio.fechainicio }} - {{ fsc.selectedEjercicio.fechafin }})
                            </p>
                            <p class="mb-2">
                                <strong>{{ i18n.trans('plazo-presentacion') }}:</strong>
                                {{ i18n.trans('plazo-modelo-425') }}
                            </p>
                            <div class="alert alert-info mb-0">
                                <i class="fa-solid fa-lightbulb fa-fw"></i>
                                {{ i18n.trans('nota-modelo-425') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Pestaña de facturas incluidas #}
            {% if fsc.modeloFiscal %}
                <div class="row mt-4 d-print-none">
                    <div class="col-12">
                        <ul class="nav nav-tabs" id="tabsFacturas425" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="facturasVentas425-tab" data-bs-toggle="tab" data-bs-target="#facturasVentas425" type="button" role="tab">
                                    <i class="fa-solid fa-file-invoice fa-fw"></i> {{ i18n.trans('facturas-ventas') }}
                                    <span class="badge bg-primary">{{ fsc.getFacturasClienteModelo()|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="facturasCompras425-tab" data-bs-toggle="tab" data-bs-target="#facturasCompras425" type="button" role="tab">
                                    <i class="fa-solid fa-file-invoice-dollar fa-fw"></i> {{ i18n.trans('facturas-compras') }}
                                    <span class="badge bg-success">{{ fsc.getFacturasProveedorModelo()|length }}</span>
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="tabsFacturas425Content">
                            {# Facturas de ventas #}
                            <div class="tab-pane fade show active" id="facturasVentas425" role="tabpanel">
                                <div class="card border-top-0 rounded-0 rounded-bottom">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>{{ i18n.trans('codigo') }}</th>
                                                        <th>{{ i18n.trans('fecha') }}</th>
                                                        <th>{{ i18n.trans('cifnif') }}</th>
                                                        <th>{{ i18n.trans('nombre') }}</th>
                                                        <th class="text-end">{{ i18n.trans('neto') }}</th>
                                                        <th class="text-end">{{ i18n.trans('igic') }}</th>
                                                        <th class="text-end">{{ i18n.trans('total') }}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% set totalNetoVentas = 0 %}
                                                    {% set totalIgicVentas = 0 %}
                                                    {% for factura in fsc.getFacturasClienteModelo() %}
                                                        {% set totalNetoVentas = totalNetoVentas + factura.neto %}
                                                        {% set totalIgicVentas = totalIgicVentas + factura.totaligic %}
                                                        <tr>
                                                            <td><a href="{{ factura.urlFactura() }}" target="_blank">{{ factura.codigo }}</a></td>
                                                            <td>{{ factura.fecha }}</td>
                                                            <td>{{ factura.cifnif }}</td>
                                                            <td>{{ factura.nombre|length > 30 ? factura.nombre|slice(0, 30) ~ '…' : factura.nombre }}</td>
                                                            <td class="text-end">{{ money(factura.neto) }}</td>
                                                            <td class="text-end">{{ money(factura.totaligic) }}</td>
                                                            <td class="text-end">{{ money(factura.total()) }}</td>
                                                        </tr>
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="7" class="text-muted text-center">{{ i18n.trans('sin-datos') }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot class="table-primary">
                                                    <tr>
                                                        <th colspan="4">{{ i18n.trans('total') }}</th>
                                                        <th class="text-end">{{ money(totalNetoVentas) }}</th>
                                                        <th class="text-end">{{ money(totalIgicVentas) }}</th>
                                                        <th class="text-end">{{ money(totalNetoVentas + totalIgicVentas) }}</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# Facturas de compras #}
                            <div class="tab-pane fade" id="facturasCompras425" role="tabpanel">
                                <div class="card border-top-0 rounded-0 rounded-bottom">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover table-sm mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>{{ i18n.trans('codigo') }}</th>
                                                        <th>{{ i18n.trans('fecha') }}</th>
                                                        <th>{{ i18n.trans('cifnif') }}</th>
                                                        <th>{{ i18n.trans('nombre') }}</th>
                                                        <th class="text-end">{{ i18n.trans('neto') }}</th>
                                                        <th class="text-end">{{ i18n.trans('igic') }}</th>
                                                        <th class="text-end">{{ i18n.trans('total') }}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% set totalNetoCompras = 0 %}
                                                    {% set totalIgicCompras = 0 %}
                                                    {% for factura in fsc.getFacturasProveedorModelo() %}
                                                        {% set totalNetoCompras = totalNetoCompras + factura.neto %}
                                                        {% set totalIgicCompras = totalIgicCompras + factura.totaligic %}
                                                        <tr>
                                                            <td><a href="{{ factura.urlFactura() }}" target="_blank">{{ factura.codigo }}</a></td>
                                                            <td>{{ factura.fecha }}</td>
                                                            <td>{{ factura.cifnif }}</td>
                                                            <td>{{ factura.nombre|length > 30 ? factura.nombre|slice(0, 30) ~ '…' : factura.nombre }}</td>
                                                            <td class="text-end">{{ money(factura.neto) }}</td>
                                                            <td class="text-end">{{ money(factura.totaligic) }}</td>
                                                            <td class="text-end">{{ money(factura.total()) }}</td>
                                                        </tr>
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="7" class="text-muted text-center">{{ i18n.trans('sin-datos') }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot class="table-success">
                                                    <tr>
                                                        <th colspan="4">{{ i18n.trans('total') }}</th>
                                                        <th class="text-end">{{ money(totalNetoCompras) }}</th>
                                                        <th class="text-end">{{ money(totalIgicCompras) }}</th>
                                                        <th class="text-end">{{ money(totalNetoCompras + totalIgicCompras) }}</th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="alert alert-warning">
                <i class="fa-solid fa-exclamation-triangle fa-fw"></i>
                {{ i18n.trans('seleccione-ejercicio') }}
            </div>
        {% endif %}
    </div>

    {# Modal para marcar como presentado #}
    {% if fsc.modeloFiscal and fsc.modeloFiscal.estado == 'borrador' %}
        <div class="modal fade" id="modalMarcarPresentado425" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ fsc.url() }}" method="post">
                        <input type="hidden" name="proceso" value="marcar-presentado">
                        <input type="hidden" name="codejercicio" value="{{ fsc.selectedEjercicio.codejercicio }}">
                        <input type="hidden" name="idmodelo" value="{{ fsc.modeloFiscal.idmodelo }}">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fa-solid fa-check fa-fw"></i> {{ i18n.trans('marcar-presentado') }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="numeroreferencia425" class="form-label">{{ i18n.trans('numero-referencia-atc') }}</label>
                                <input type="text" name="numeroreferencia" id="numeroreferencia425" class="form-control" placeholder="Opcional">
                            </div>
                            <div class="mb-3">
                                <label for="fechapresentacion425" class="form-label">{{ i18n.trans('fecha-presentacion') }}</label>
                                <input type="date" name="fechapresentacion" id="fechapresentacion425" class="form-control" value="{{ "now"|date("Y-m-d") }}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ i18n.trans('cancelar') }}</button>
                            <button type="submit" class="btn btn-success">
                                <i class="fa-solid fa-check fa-fw"></i> {{ i18n.trans('marcar-presentado') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
